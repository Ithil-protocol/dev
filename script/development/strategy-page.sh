#/bin/bash
set -e

SCRIPT_DIR=$(pwd)
BROADCAST_DIR=$SCRIPT_DIR/../../broadcast
DEPLOYSERVICE_LOG=$BROADCAST_DIR/CreateVault.script.sol/42161/run-latest.json
REPORT_FILE=$SCRIPT_DIR/devnetwork.report

# vars
PRIVATE_KEY="0x8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba"
WALLET1="0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc"
LOCALHOST_RPC="http://localhost:8545"

USDC_CONTRACT="0xFF970A61A04b1cA14834A43f5dE4533eBDDB5CC8"
USDT_CONTRACT="0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9"
DAI_CONTRACT="0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1"
WETH_CONTRACT="0x82aF49447D8a07e3bd95BD0d56f35241523fBab1"
WBTC_CONTRACT="0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f"

MANAGER="0x1Eb835EB7BEEEE9E6bbFe08F16a2d2eF668204bd"
AAVE_POOL="0x794a61358D6845594F94dc1DB02A252b5b4814aD"
CAP="1000000000000000000"

# commands
cd ..
# deploy manager
PRIVATE_KEY=$PRIVATE_KEY MANAGER=$MANAGER AAVE=$AAVE_POOL \
  forge script -f $LOCALHOST_RPC DeployAaveService.script.sol --broadcast
LAST_SERVICE=$(cat $DEPLOYSERVICE_LOG | jq -r '.transactions[0].contractAddress')
# usdc
PRIVATE_KEY=$PRIVATE_KEY MANAGER=$MANAGER SERVICE=$LAST_SERVICE TOKEN=$USDC_CONTRACT CAP=$CAP \
  forge script -f $LOCALHOST_RPC SetCap.script.sol --broadcast
PRIVATE_KEY=$PRIVATE_KEY MANAGER=$MANAGER SERVICE=$LAST_SERVICE TOKEN=$USDT_CONTRACT CAP=$CAP \
  forge script -f $LOCALHOST_RPC SetCap.script.sol --broadcast
PRIVATE_KEY=$PRIVATE_KEY MANAGER=$MANAGER SERVICE=$LAST_SERVICE TOKEN=$DAI_CONTRACT CAP=$CAP \
  forge script -f $LOCALHOST_RPC SetCap.script.sol --broadcast
PRIVATE_KEY=$PRIVATE_KEY MANAGER=$MANAGER SERVICE=$LAST_SERVICE TOKEN=$WETH_CONTRACT CAP=$CAP \
  forge script -f $LOCALHOST_RPC SetCap.script.sol --broadcast
PRIVATE_KEY=$PRIVATE_KEY MANAGER=$MANAGER SERVICE=$LAST_SERVICE TOKEN=$WBTC_CONTRACT CAP=$CAP \
  forge script -f $LOCALHOST_RPC SetCap.script.sol --broadcast

# report what has been done
echo "AAVE Service: $LAST_SERVICE" | tee -a $REPORT_FILE
